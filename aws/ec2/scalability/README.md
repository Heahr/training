## AWS EC2 Scalability

##### AWS EC2를 이용해 급변하는 인스턴스의 규모를 유연하게 변경해보자.  

#### Scalability를 보장해야 하는 이유  

앞서 AWS EC2 Basic에서는 간단한 실습을 진행했다. 이 문서에서는 앞선 문서와는 다르게 AWS EC2를 실습보다 이론적으로 정리하게 될 것이다.  

클라우드 컴퓨팅의 핵심적인 특징은 '가상화'와 '종량제'이다. AWS EC2가 가장 대표적으로 가상화와 종량제를 제공하고 있기 때문에 이를 통해 자세하게 살펴보자.  

일반적으로 '가상머신'이라고 하면 논리적으로는 컴퓨터와 똑같이 동작하지만, 물리적으로는 존재하지 않는 기계라고 설명한다. 여기서의 물리적은 사용자 입장에서의 물리적인 공간을 이야기하며, 실제로는 물리적으로도 장비가 존재하고 있다.  

가상머신을 사용한다고 하면, 운영체제에 가상머신이라는 소프트웨어로 만든 기계를 설치해 이를 사용하는 것을 말한다. 실제로는 하나의 운영체제가 동작하지만, 가상머신 위에 여러 운영체제를 설치해 사용자의 입장에서는 여러 운영체제를 사용한다고 느낄 수 있다는 것이다.  

현재의 클라우드 컴퓨팅의 가장 주요 고객은 '기업'이다. 그렇기 때문에 주요 사용처는 두 가지로 나눌 수 있다.  

스타트업과 같이 방문 고객이 적은 경우 성능은 다소 떨어지지만, 저렴한 컴퓨터를 사용하는 경우와 대기업과 같이 방문 고객이 많고, 아주 강력한 컴퓨터가 필요한 경우가 그 예이다.  

일반적으로 성능을 이렇게 구분하는 이유는 Scalability를 제공하기 위함이다. 우리의 고객은 고정되어있지 않고, 유동적이기 때문에 컴퓨터의 성능을 유동적으로 조정한다면 완벽할 것이다.  

클라우드 컴퓨터를 사용하기 이전의 비즈니스에서 Scalability를 보장하는 방법은 물리적으로 직접 관리하는 방법이었다. 비즈니스는 항상 성장하지 않기 때문에 물리적으로 컴퓨터의 스케일을 늘리는 일은 기업의 입장에서는 부담스러울 수밖에 없다. 그렇기 때문에 클라우드 컴퓨터를 사용하는 것이 효율적이다.  

#### Stress Test  

Scale Up이라고 하면, 컴퓨터를 Upgrade하는 것이라고 보면 된다. 우리 회사의 트래픽이 증가하면 Scale Up을 하고, 감소하면 Scale Down을 하면 되는 것이다.  

Scale Up & Down을 테스트하기 위해 필요한 인스턴스는 2개이다. 한쪽에서는 웹 서버를 구동시키고, 다른 한쪽에서는 구동되어 있는 웹 서버에 계속적으로 접속하는 방법이다.  

이는 'Stress Test'라고 하며, 웹에 국한된 이야기가 아닌 컴퓨터를 사용하는 모든 분야에 적용할 수 있다. User와 Server로 구성하며, Server에 해당하는 컴퓨터는 Scale을 조절해가며 User의 요구를 소화해내는 과정이다.  

수동으로는 사용자가 아무리 접속해도 부하가 일어나지 않는다. 그렇기 때문에 apache2-utils를 설치해 ab를 사용해 부하를 발생시킬 것이다.  

```
User$ sudo apt-get update  
User$ sudo apt-get install apache-utils  
// apache-utils를 설치한다  

...
Server$ top
// 이 과정에서 우리의 서버는 현재 프로세스의 상황을 지켜보도록 하자  

User$ ab 
// 사용법을 확인하고 이를 통해 부하를 발생시켜 보자  

User$ ab -n 400 -c 1 http://웹 서버 주소  
// -n: 접속하고자 하는 유저는 400명, 동시 접속은 최대 1명, 즉 하지 않겠다  
// 이제 서버의 프로세스 변화를 살펴보자  
```

이제 ab의 결과를 살펴보자.  

* Concurrency Level: 동시 접속  
* Time taken for tests: 총 소요 시간, 즉 모든 사용자가 최선을 다해 접속했을 때의 소요시간을 의미한다.  
* Complete requests: 성공한 요청  
* Failed requests: 실패한 요청  
* Requests per second: 초당 처리 속도, 즉 우리의 인스턴스가 초당 수행할 수 있는 처리의 속도를 의미한다.  
* Time per request: 개별 처리 속도, 즉 평균적으로 하나의 유저에 대한 처리 속도를 의미한다.  
  
이제 동시접속자의 수를 늘려가며 실습을 진행해 어떠한 점이 달라졌는지를 살펴보도록 하자.  

필자의 경우에는 상대적으로 총 소요시간은 줄어들었지만, 개별 처리 속도가 증가한 것을 확연히 느낄 수 있었다. 이것을 좀 더 느끼기 위해서는 ab를 실행하면서 직접적을 웹 서버 주소로 접속해보는 것이다.  

#### Elastic IP  

우리의 인스턴스를 Stop 했다가 다시 Start 시키면 IP는 달라진다. 이는 IP 고갈과 밀접한 관계가 있는데, IPv4에서는 40억개 정도의 컴퓨터만 IP Address를 가진다.  

그렇기 때문에 기본적으로 AWS는 한정된 IP Address를 절약하기 위해 Stop 후 Start 할 때는 IP가 바뀌는 시스템이 실행되어 이전과는 다른 IP를 제공한다.  

그렇다면 고정 IP를 사용하고자 할 때는 어떻게 해야 할까? 그것은 'Elasic IP'를 사용하면 된다. 최대 1개까지의 Elastic IP는 무료이기 때문에 free tier로는 하나의 인스턴스에 하나의 Elastic IP를 부여할 수 있는 것이다.  

> 그 이상 부여받거나 인스턴스에 붙어있지 않은 'Elastic IP'를 가지고 있다면 과금이 부여된다. 'Elastic IP'는 EC2 메뉴 중에 Network와 관련된 메뉴에서 찾을 수 있다.  

#### Scale Up  

Stress Test를 통해 우리는 Scale Up의 필요성을 느꼈다. 그렇다면 본격적으로 AWS를 이용해 Scale Up을 하는 방법을 살펴보자.  

우선은 우리의 인스턴스를 이미지로 만들 필요가 있다. 인스턴스의 옵션에서 'Create Image'를 눌러 이미지를 생성해보자.  

> 이미지를 만드는 과정에서 인스턴스는 종료된다. 현재 서비스 중인 프로그램이라면 갑작스런 이미지 생성은 부적절한 결과를 가져올 것이다.  

이미지가 준비되면 이미지를 기반으로 인스턴스를 만들어 'Scale Up'을 진행하면 된다. 이 경우에는 지금까지 사용한 자원들을 인스턴스의 Monitoring을 통해 살펴보고, 어떤 인스턴스 타입을 만들지 결정하도록 하면 된다.  

본격적으로 EC2 메뉴에서 'AMIs'을 찾아 이동해 생성한 이미지에서 오른쪽 클릭 후 'Lanch'를 통해 Scale Up을 진행하도록 하자. 그리고 나서는 인스턴스 타입과 다양한 추가 사항을 추가하고, 상단의 Review 탭에서 확장하기 전의 인스턴스가 속한 Security Group을 선정하도록 하자.  

이후에는 기본적으로 인스턴스를 생성하는 것과 동일하게 진행하면 된다. 모든 과정을 완료하고 나서 Instances에 새로운 인스턴스가 생성되었는지 확인하도록 하자.  

여기까지 완료했으면 한 가지 의문이 든다.  

> "기존의 인스턴스로 서비스를 운영하고 있는 상황인데, 어떻게 새로운 인스턴스로 경로를 변경시킬까?"  
  
여기에 대한 답은 앞서 설명한 'Elastic IP'를 사용하는 것이다. 고정된 IP의 주소를 할당시켜 이전의 서비스로 접속하는 것이 아닌 'Scale Up'이 진행된 서비스로 접속하게 만들어 주는 것이다.  

그 과정은 'Elastic IP'로 들어가 IP가 지정된 이전의 서비스에 대해 할당을 해제하고 다시 새로운 서비스에 할당하는 것으로 간단하게 진행할 수 있다.  

> 추가적으로 다시 Stress Test를 진행해 Scale Up이 잘 진행되었는지 확인해보자. 가령 기존의 서비스는 마이크로 인스턴스였다면, Scale Up한 서비스는 라지 인스턴스라고 할 때 둘의 차이를 확인해보는 것이다.  
>
> 하나의 컴퓨터의 성능을 끌어올리는 'Scale Up'을 통해 Scalability를 보장하는 것에는 한계가 있다. 가령 AWS의 인스턴스 타입 중 가장 큰 타입보다 빠른 속도의 환경이 필요한 경우가 그것이다. 이러한 한계를 극복하기 위해 여러 컴퓨터를 하나의 서비스에 사용하는 'Scale Out'에 대한 이야기도 이후에 진행하도록 할 것이다.  


#### 참고자료  
[생활코딩 - AWS EC2 Scalability](https://opentutorials.org/course/2717/11294)  


